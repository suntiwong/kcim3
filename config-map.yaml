apiVersion: v1
kind: ConfigMap
metadata:
  namespace: kcim
  name: kong-api-gw-config
data:
  # ✅ 1. kong.conf — สำคัญมาก! ต้องมีเพื่อเปิดโหมด DB-less และชี้ไปที่ kong.yml
  kong.conf: |-
    database = off
    declarative_config = /usr/local/kong/kong.yml
    nginx_worker_processes = 1
    log_level = debug
    proxy_listen = 0.0.0.0:8000
    admin_listen = 0.0.0.0:8001
    # ปิดการสร้าง default cert (เพื่อหลีกเลี่ยง read-only error)
    ssl_cert_default =
    ssl_cert_key_default =

  # ✅ 2. kong.yml — ใช้ชื่อนี้เพื่อให้ตรงกับ declarative_config
  kong.yml: |-
    _format_version: "2.1"

    consumers:
      - username: kcc
        custom_id: kcc
      - username: iamusr
        custom_id: iamusr

    basicauth_credentials:
      - consumer: kcc
        username: kcc
        password: "Kcc@123!"
      - consumer: iamusr
        username: iamusr
        password: "iamusr@123!"

    services:
      # ===== AUTH (9090) =====
      - name: auth-service
        protocol: http
        host: auth-service.kcim.svc.cluster.local
        port: 9090
        path: /api/auth
        routes:
          - name: auth-route
            paths:
              - /api/auth
            strip_path: true

      - name: authen-detail-service
        protocol: http
        host: auth-service.kcim.svc.cluster.local
        port: 9090
        path: /api/auth-detail
        plugins:
          - name: custom-auth
            config:
              authVerifyTokenEndpoint: http://auth-service.kcim.svc.cluster.local:9090/verifyToken
        routes:
          - name: auth-detail-route
            paths:
              - /api/auth-detail
            strip_path: true

      # ... (ส่วนอื่นๆ คงเดิม — ไม่ต้องเปลี่ยน)

      # ===== ADMIN (9095) =====
      - name: admin-health
        protocol: http
        host: admin-service.kcim.svc.cluster.local
        port: 9095
        path: /actuator
        routes:
          - name: admin-health-route
            paths:
              - /api/admin-health
            strip_path: true

  # ❌ ลบ my-server.kong.conf ออกได้เลย — ไม่จำเป็น
