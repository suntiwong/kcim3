apiVersion: v1
kind: Namespace
metadata:
  name: kcim
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-dbless-config
  namespace: kcim
data:
  kong.yml: |-
    _format_version: "2.1"

    # === ตัวอย่าง config DB-less ===
    # ปรับตามที่คุณต้องการได้เลย

    consumers:
      - username: kcc
        custom_id: kcc
      - username: iamusr
        custom_id: iamusr

    basicauth_credentials:
      - consumer: kcc
        username: kcc
        password: "Kcc@123!"
      - consumer: iamusr
        username: iamusr
        password: "iamusr@123!"

    services:
      - name: auth-service
        protocol: http
        host: auth-service.kcim.svc.cluster.local
        port: 8080
        path: /api/auth
        routes:
          - name: auth-route
            paths:
              - /api/auth
            strip_path: true

      # ตัวอย่าง plugin (ถ้า image มี plugin นี้อยู่แล้ว)
      - name: auth-detail-service
        protocol: http
        host: auth-service.kcim.svc.cluster.local
        port: 8080
        path: /api/auth-detail
        plugins:
          - name: custom-auth
            config:
              authVerifyTokenEndpoint: http://auth-service.kcim.svc.cluster.local:8080/verifyToken
        routes:
          - name: auth-detail-route
            paths:
              - /api/auth-detail
            strip_path: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong
  namespace: kcim
  labels:
    app: kong
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kong
  template:
    metadata:
      labels:
        app: kong
    spec:
      containers:
        - name: kong
          image: teegolf/kong-dbless:0.5.47
          imagePullPolicy: IfNotPresent
          ports:
            - name: proxy
              containerPort: 8000
            - name: admin
              containerPort: 8001
          env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: "/etc/kong/kong.yml"

            # ถ้า image ของคุณมี plugin เหล่านี้จริง ให้เปิดไว้ได้
            - name: KONG_PLUGINS
              value: "bundled,custom-auth,custom-header,circuit-breaker"

            # เปิด admin ให้เรียกจากภายนอกได้
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001"

            # log พื้นฐาน
            - name: KONG_PROXY_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_ADMIN_ACCESS_LOG
              value: "/dev/stdout"
            - name: KONG_PROXY_ERROR_LOG
              value: "/dev/stderr"
            - name: KONG_ADMIN_ERROR_LOG
              value: "/dev/stderr"

          readinessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 10
            periodSeconds: 10

          livenessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 30
            periodSeconds: 10

          volumeMounts:
            - name: kong-dbless-config
              mountPath: /etc/kong/
      volumes:
        - name: kong-dbless-config
          configMap:
            name: kong-dbless-config
---
apiVersion: v1
kind: Service
metadata:
  name: kong-proxy
  namespace: kcim
  labels:
    app: kong
spec:
  type: NodePort
  selector:
    app: kong
  ports:
    - name: proxy
      port: 8000
      targetPort: 8000
      nodePort: 30080
---
apiVersion: v1
kind: Service
metadata:
  name: kong-admin
  namespace: kcim
  labels:
    app: kong
spec:
  type: NodePort
  selector:
    app: kong
  ports:
    - name: admin
      port: 8001
      targetPort: 8001
      nodePort: 30081
